if(typeof KJUR=="undefined"||!KJUR)KJUR={};if(typeof KJUR.asn1=="undefined"||!KJUR.asn1)KJUR.asn1={};if(typeof KJUR.asn1.cms=="undefined"||!KJUR.asn1.cms)KJUR.asn1.cms={};KJUR.asn1.cms.Attribute=function(params){var _Error=Error,_KJUR=KJUR,_KJUR_asn1=_KJUR.asn1,_DERSequence=_KJUR_asn1.DERSequence,_DERSet=_KJUR_asn1.DERSet,_DERObjectIdentifier=_KJUR_asn1.DERObjectIdentifier;this.params=null;this.typeOid=null;this.setByParam=function(params){this.params=params};this.getValueArray=function(){throw new _Error("not yet implemented abstract")};this.tohex=function(){var dType=new _DERObjectIdentifier({oid:this.typeOid});var dValueSet=new _DERSet({array:this.getValueArray()});var seq=new _DERSequence({array:[dType,dValueSet]});return seq.tohex()};this.getEncodedHex=function(){return this.tohex()}};extendClass(KJUR.asn1.cms.Attribute,KJUR.asn1.ASN1Object);KJUR.asn1.cms.ContentType=function(params){var _KJUR=KJUR,_KJUR_asn1=_KJUR.asn1;_KJUR_asn1.cms.ContentType.superclass.constructor.call(this);this.typeOid="1.2.840.113549.1.9.3";this.getValueArray=function(){var dOid=new _KJUR_asn1.DERObjectIdentifier(this.params.type);return[dOid]};if(params!=undefined)this.setByParam(params)};extendClass(KJUR.asn1.cms.ContentType,KJUR.asn1.cms.Attribute);KJUR.asn1.cms.MessageDigest=function(params){var _KJUR=KJUR,_KJUR_asn1=_KJUR.asn1,_DEROctetString=_KJUR_asn1.DEROctetString,_KJUR_asn1_cms=_KJUR_asn1.cms;_KJUR_asn1_cms.MessageDigest.superclass.constructor.call(this);this.typeOid="1.2.840.113549.1.9.4";this.getValueArray=function(){var dHash=new _DEROctetString(this.params);return[dHash]};if(params!=undefined)this.setByParam(params)};extendClass(KJUR.asn1.cms.MessageDigest,KJUR.asn1.cms.Attribute);KJUR.asn1.cms.SigningTime=function(params){var _KJUR=KJUR,_KJUR_asn1=_KJUR.asn1;_KJUR_asn1.cms.SigningTime.superclass.constructor.call(this);this.typeOid="1.2.840.113549.1.9.5";this.getValueArray=function(){var dTime=new _KJUR_asn1.x509.Time(this.params);return[dTime]};if(params!=undefined)this.setByParam(params)};extendClass(KJUR.asn1.cms.SigningTime,KJUR.asn1.cms.Attribute);KJUR.asn1.cms.SigningCertificate=function(params){var _Error=Error,_KJUR=KJUR,_KJUR_asn1=_KJUR.asn1,_DERSequence=_KJUR_asn1.DERSequence,_KJUR_asn1_cms=_KJUR_asn1.cms,_ESSCertID=_KJUR_asn1_cms.ESSCertID,_KJUR_crypto=_KJUR.crypto;_KJUR_asn1_cms.SigningCertificate.superclass.constructor.call(this);this.typeOid="1.2.840.113549.1.9.16.2.12";this.getValueArray=function(){if(this.params==null||this.params==undefined||this.params.array==undefined){throw new _Error("parameter 'array' not specified")}var aESSCertIDParam=this.params.array;var aESSCertID=[];for(var i=0;i<aESSCertIDParam.length;i++){var idparam=aESSCertIDParam[i];if(params.hasis==false&&(typeof idparam=="string"&&(idparam.indexOf("-----BEGIN")!=-1||ASN1HEX.isASN1HEX(idparam)))){idparam={cert:idparam}}if(idparam.hasis!=false&&params.hasis==false){idparam.hasis=false}aESSCertID.push(new _ESSCertID(idparam))}var dCerts=new _DERSequence({array:aESSCertID});var dSigningCertificate=new _DERSequence({array:[dCerts]});return[dSigningCertificate]};if(params!=undefined)this.setByParam(params)};extendClass(KJUR.asn1.cms.SigningCertificate,KJUR.asn1.cms.Attribute);KJUR.asn1.cms.ESSCertID=function(params){KJUR.asn1.cms.ESSCertID.superclass.constructor.call(this);var _Error=Error,_KJUR=KJUR,_KJUR_asn1=_KJUR.asn1,_DEROctetString=_KJUR_asn1.DEROctetString,_DERSequence=_KJUR_asn1.DERSequence,_IssuerSerial=_KJUR_asn1.cms.IssuerSerial;this.params=null;this.getCertHash=function(params,defaultAlg){if(params.hash!=undefined)return params.hash;if(typeof params=="string"&&params.indexOf("-----BEGIN")==-1&&!ASN1HEX.isASN1HEX(params)){return params}var certPEMorHex;if(typeof params=="string"){certPEMorHex=params}else if(params.cert!=undefined){certPEMorHex=params.cert}else{throw new _Error("hash nor cert unspecified")}var hCert;if(certPEMorHex.indexOf("-----BEGIN")!=-1){hCert=pemtohex(certPEMorHex)}else{hCert=certPEMorHex}if(typeof params=="string"){if(params.indexOf("-----BEGIN")!=-1){hCert=pemtohex(params)}else if(ASN1HEX.isASN1HEX(params)){hCert=params}}var alg;if(params.alg!=undefined){alg=params.alg}else if(defaultAlg!=undefined){alg=defaultAlg}else{throw new _Error("hash alg unspecified")}return _KJUR.crypto.Util.hashHex(hCert,alg)};this.tohex=function(){var params=this.params;var hCertHash=this.getCertHash(params,"sha1");var a=[];a.push(new _DEROctetString({hex:hCertHash}));if(typeof params=="string"&&params.indexOf("-----BEGIN")!=-1||params.cert!=undefined&&params.hasis!=false||params.issuer!=undefined&&params.serial!=undefined)a.push(new _IssuerSerial(params));var seq=new _DERSequence({array:a});return seq.tohex()};this.getEncodedHex=function(){return this.tohex()};if(params!=undefined)this.setByParam(params)};extendClass(KJUR.asn1.cms.ESSCertID,KJUR.asn1.ASN1Object);KJUR.asn1.cms.SigningCertificateV2=function(params){var _Error=Error,_KJUR=KJUR,_KJUR_asn1=_KJUR.asn1,_DERSequence=_KJUR_asn1.DERSequence,_KJUR_asn1_x509=_KJUR_asn1.x509,_KJUR_asn1_cms=_KJUR_asn1.cms,_ESSCertIDv2=_KJUR_asn1_cms.ESSCertIDv2,_KJUR_crypto=_KJUR.crypto;_KJUR_asn1_cms.SigningCertificateV2.superclass.constructor.call(this);this.typeOid="1.2.840.113549.1.9.16.2.47";this.getValueArray=function(){if(this.params==null||this.params==undefined||this.params.array==undefined){throw new _Error("parameter 'array' not specified")}var aESSCertIDv2Param=this.params.array;var aESSCertIDv2=[];for(var i=0;i<aESSCertIDv2Param.length;i++){var idparam=aESSCertIDv2Param[i];if((params.alg!=undefined||params.hasis==false)&&(typeof idparam=="string"&&(idparam.indexOf("-----BEGIN")!=-1||ASN1HEX.isASN1HEX(idparam)))){idparam={cert:idparam}}if(idparam.alg==undefined&&params.alg!=undefined){idparam.alg=params.alg}if(idparam.hasis!=false&&params.hasis==false){idparam.hasis=false}aESSCertIDv2.push(new _ESSCertIDv2(idparam))}var dCerts=new _DERSequence({array:aESSCertIDv2});var dSigningCertificatev2=new _DERSequence({array:[dCerts]});return[dSigningCertificatev2]};if(params!=undefined)this.setByParam(params)};extendClass(KJUR.asn1.cms.SigningCertificateV2,KJUR.asn1.cms.Attribute);KJUR.asn1.cms.ESSCertIDv2=function(params){KJUR.asn1.cms.ESSCertIDv2.superclass.constructor.call(this);var _Error=Error,_KJUR=KJUR,_KJUR_asn1=_KJUR.asn1,_DEROctetString=_KJUR_asn1.DEROctetString,_DERSequence=_KJUR_asn1.DERSequence,_IssuerSerial=_KJUR_asn1.cms.IssuerSerial,_AlgorithmIdentifier=_KJUR_asn1.x509.AlgorithmIdentifier;this.params=null;this.tohex=function(){var params=this.params;var hCertHash=this.getCertHash(params,"sha256");var a=[];if(params.alg!=undefined&&params.alg!="sha256")a.push(new _AlgorithmIdentifier({name:params.alg}));a.push(new _DEROctetString({hex:hCertHash}));if(typeof params=="string"&&params.indexOf("-----BEGIN")!=-1||params.cert!=undefined&&params.hasis!=false||params.issuer!=undefined&&params.serial!=undefined)a.push(new _IssuerSerial(params));var seq=new _DERSequence({array:a});return seq.tohex()};this.getEncodedHex=function(){return this.tohex()};if(params!=undefined)this.setByParam(params)};extendClass(KJUR.asn1.cms.ESSCertIDv2,KJUR.asn1.cms.ESSCertID);KJUR.asn1.cms.IssuerSerial=function(params){var _Error=Error,_KJUR=KJUR,_KJUR_asn1=_KJUR.asn1,_DERInteger=_KJUR_asn1.DERInteger,_DERSequence=_KJUR_asn1.DERSequence,_KJUR_asn1_cms=_KJUR_asn1.cms,_KJUR_asn1_x509=_KJUR_asn1.x509,_GeneralNames=_KJUR_asn1_x509.GeneralNames,_X509=X509;_KJUR_asn1_cms.IssuerSerial.superclass.constructor.call(this);this.setByParam=function(params){this.params=params};this.tohex=function(){var params=this.params;var pIssuer,pSerial;if(typeof params=="string"&&params.indexOf("-----BEGIN")!=-1||params.cert!=undefined){var pem;if(params.cert!=undefined){pem=params.cert}else{pem=params}var x=new _X509;x.readCertPEM(pem);pIssuer=x.getIssuer();pSerial={hex:x.getSerialNumberHex()}}else if(params.issuer!=undefined&&params.serial){pIssuer=params.issuer;pSerial=params.serial}else{throw new _Error("cert or issuer and serial parameter not specified")}var dIssuer=new _GeneralNames([{dn:pIssuer}]);var dSerial=new _DERInteger(pSerial);var seq=new _DERSequence({array:[dIssuer,dSerial]});return seq.tohex()};this.getEncodedHex=function(){return this.tohex()};if(params!=undefined)this.setByParam(params)};extendClass(KJUR.asn1.cms.IssuerSerial,KJUR.asn1.ASN1Object);KJUR.asn1.cms.SignerIdentifier=function(params){var _KJUR=KJUR,_KJUR_asn1=_KJUR.asn1,_DERInteger=_KJUR_asn1.DERInteger,_DERSequence=_KJUR_asn1.DERSequence,_KJUR_asn1_cms=_KJUR_asn1.cms,_IssuerAndSerialNumber=_KJUR_asn1_cms.IssuerAndSerialNumber,_SubjectKeyIdentifier=_KJUR_asn1_cms.SubjectKeyIdentifier,_KJUR_asn1_x509=_KJUR_asn1.x509,_X500Name=_KJUR_asn1_x509.X500Name,_X509=X509,_Error=Error;_KJUR_asn1_cms.SignerIdentifier.superclass.constructor.call(this);this.params=null;this.tohex=function(){var params=this.params;if(params.type=="isssn"){var dISSSN=new _IssuerAndSerialNumber(params);return dISSSN.tohex()}else if(params.type=="skid"){var dSKID=new _SubjectKeyIdentifier(params);return dSKID.tohex()}else{throw new Error("wrong property for isssn or skid")}};this.getEncodedHex=function(){return this.tohex()};if(params!=undefined)this.setByParam(params)};extendClass(KJUR.asn1.cms.SignerIdentifier,KJUR.asn1.ASN1Object);KJUR.asn1.cms.IssuerAndSerialNumber=function(params){var _KJUR=KJUR,_KJUR_asn1=_KJUR.asn1,_DERInteger=_KJUR_asn1.DERInteger,_DERSequence=_KJUR_asn1.DERSequence,_KJUR_asn1_cms=_KJUR_asn1.cms,_KJUR_asn1_x509=_KJUR_asn1.x509,_X500Name=_KJUR_asn1_x509.X500Name,_X509=X509,_Error=Error;_KJUR_asn1_cms.IssuerAndSerialNumber.superclass.constructor.call(this);this.params=null;this.tohex=function(){var params=this.params;var pIssuer,pSerial;if(typeof params=="string"&&params.indexOf("-----BEGIN")!=-1||params.cert!=undefined){var pem;if(params.cert!=undefined){pem=params.cert}else{pem=params}var x=new _X509;x.readCertPEM(pem);pIssuer=x.getIssuer();pSerial={hex:x.getSerialNumberHex()}}else if(params.issuer!=undefined&&params.serial){pIssuer=params.issuer;pSerial=params.serial}else{throw new _Error("cert or issuer and serial parameter not specified")}var dIssuer=new _X500Name(pIssuer);var dSerial=new _DERInteger(pSerial);var seq=new _DERSequence({array:[dIssuer,dSerial]});return seq.tohex()};this.getEncodedHex=function(){return this.tohex()};this.setByParam=function(params){this.params=params};if(params!=undefined)this.setByParam(params)};extendClass(KJUR.asn1.cms.IssuerAndSerialNumber,KJUR.asn1.ASN1Object);KJUR.asn1.cms.SubjectKeyIdentifier=function(params){var _KJUR=KJUR,_KJUR_asn1=_KJUR.asn1,_DERInteger=_KJUR_asn1.DERInteger,_DERSequence=_KJUR_asn1.DERSequence,_newObject=_KJUR_asn1.ASN1Util.newObject,_KJUR_asn1_cms=_KJUR_asn1.cms,_IssuerAndSerialName=_KJUR_asn1_cms.IssuerAndSerialName,_SubjectKeyIdentifier=_KJUR_asn1_cms.SubjectKeyIdentifier,_KJUR_asn1_x509=_KJUR_asn1.x509,_X500Name=_KJUR_asn1_x509.X500Name,_X509=X509,_Error=Error;_KJUR_asn1_cms.SubjectKeyIdentifier.superclass.constructor.call(this);this.tohex=function(){var params=this.params;if(params.cert==undefined&&params.skid==undefined)throw new _Error("property cert nor skid undefined");var hSKID;if(params.cert!=undefined){var x=new _X509(params.cert);var pSKID=x.getExtSubjectKeyIdentifier();hSKID=pSKID.kid.hex}else if(params.skid!=undefined){hSKID=params.skid}var dSKID=_newObject({tag:{tage:"a0",obj:{octstr:{hex:hSKID}}}});return dSKID.tohex()};this.getEncodedHex=function(){return this.tohex()};if(params!=undefined)this.setByParam(params)};extendClass(KJUR.asn1.cms.SubjectKeyIdentifier,KJUR.asn1.ASN1Object);KJUR.asn1.cms.AttributeList=function(params){var _Error=Error,_KJUR=KJUR,_KJUR_asn1=_KJUR.asn1,_DERSet=_KJUR_asn1.DERSet,_KJUR_asn1_cms=_KJUR_asn1.cms;_KJUR_asn1_cms.AttributeList.superclass.constructor.call(this);this.params=null;this.hTLV=null;this.setByParam=function(params){this.params=params};this.tohex=function(){var params=this.params;if(this.hTLV!=null)return this.hTLV;var sortflag=true;if(params.sortflag!=undefined){sortflag=params.sortflag}var aAttrParam=params.array;var a=[];for(var i=0;i<aAttrParam.length;i++){var pAttr=aAttrParam[i];var attrName=pAttr.attr;if(attrName=="contentType"){a.push(new _KJUR_asn1_cms.ContentType(pAttr))}else if(attrName=="messageDigest"){a.push(new _KJUR_asn1_cms.MessageDigest(pAttr))}else if(attrName=="signingTime"){a.push(new _KJUR_asn1_cms.SigningTime(pAttr))}else if(attrName=="signingCertificate"){a.push(new _KJUR_asn1_cms.SigningCertificate(pAttr))}else if(attrName=="signingCertificateV2"){a.push(new _KJUR_asn1_cms.SigningCertificateV2(pAttr))}else if(attrName=="signaturePolicyIdentifier"){a.push(new KJUR.asn1.cades.SignaturePolicyIdentifier(pAttr))}else if(attrName=="signatureTimeStamp"||attrName=="timeStampToken"){a.push(new KJUR.asn1.cades.SignatureTimeStamp(pAttr))}else{throw new _Error("unknown attr: "+attrName)}}var dSet=new _DERSet({array:a,sortflag:sortflag});this.hTLV=dSet.tohex();return this.hTLV};this.getEncodedHex=function(){return this.tohex()};if(params!=undefined)this.setByParam(params)};extendClass(KJUR.asn1.cms.AttributeList,KJUR.asn1.ASN1Object);KJUR.asn1.cms.SignerInfo=function(params){var _Error=Error,_KJUR=KJUR,_KJUR_asn1=_KJUR.asn1,_DERInteger=_KJUR_asn1.DERInteger,_DEROctetString=_KJUR_asn1.DEROctetString,_DERSequence=_KJUR_asn1.DERSequence,_DERTaggedObject=_KJUR_asn1.DERTaggedObject,_KJUR_asn1_cms=_KJUR_asn1.cms,_SignerIdentifier=_KJUR_asn1_cms.SignerIdentifier,_AttributeList=_KJUR_asn1_cms.AttributeList,_ContentType=_KJUR_asn1_cms.ContentType,_EncapsulatedContentInfo=_KJUR_asn1_cms.EncapsulatedContentInfo,_MessageDigest=_KJUR_asn1_cms.MessageDigest,_SignedData=_KJUR_asn1_cms.SignedData,_KJUR_asn1_x509=_KJUR_asn1.x509,_AlgorithmIdentifier=_KJUR_asn1_x509.AlgorithmIdentifier,_KJUR_crypto=_KJUR.crypto,_KEYUTIL=KEYUTIL;_KJUR_asn1_cms.SignerInfo.superclass.constructor.call(this);this.params=null;this.sign=function(){var params=this.params;var sigalg=params.sigalg;var hData=new _AttributeList(params.sattrs).tohex();var prvkey=null;var sig;if(params.provName===undefined||params.provName.substr(0,6)!=="pkcs11"){prvkey=_KEYUTIL.getKey(params.signkey,params.signkeypass);sig=new _KJUR_crypto.Signature({alg:sigalg})}else{prvkey=params.signkey;sig=new _KJUR.crypto.adds.HSMSignature({alg:sigalg,prov:params.provName,provInfo:params.provInfo})}sig.init(prvkey);sig.updateHex(hData);var hSig=sig.sign();params.sighex=hSig};this.tohex=function(){var params=this.params;var a=[];a.push(new _DERInteger({int:params.version}));a.push(new _SignerIdentifier(params.id));a.push(new _AlgorithmIdentifier({name:params.hashalg}));if(params.sattrs!=undefined){var dList=new _AttributeList(params.sattrs);try{a.push(new _DERTaggedObject({tag:"a0",explicit:false,obj:dList}))}catch(ex){throw new _Error("si sattr error: "+ex)}}if(params.sigalgfield!=undefined){a.push(new _AlgorithmIdentifier({name:params.sigalgfield}))}else{a.push(new _AlgorithmIdentifier({name:params.sigalg}))}if(params.sighex==undefined&&params.signkey!=undefined){this.sign()}a.push(new _DEROctetString({hex:params.sighex}));if(params.uattrs!=undefined){var dList=new _AttributeList(params.uattrs);try{a.push(new _DERTaggedObject({tag:"a1",explicit:false,obj:dList}))}catch(ex){throw new _Error("si uattr error: "+ex)}}var seq=new _DERSequence({array:a});return seq.tohex()};this.getEncodedHex=function(){return this.tohex()};if(params!=undefined)this.setByParam(params)};extendClass(KJUR.asn1.cms.SignerInfo,KJUR.asn1.ASN1Object);KJUR.asn1.cms.EncapsulatedContentInfo=function(params){var _KJUR=KJUR,_KJUR_asn1=_KJUR.asn1,_DERTaggedObject=_KJUR_asn1.DERTaggedObject,_DERSequence=_KJUR_asn1.DERSequence,_DERObjectIdentifier=_KJUR_asn1.DERObjectIdentifier,_DEROctetString=_KJUR_asn1.DEROctetString,_KJUR_asn1_cms=_KJUR_asn1.cms;_KJUR_asn1_cms.EncapsulatedContentInfo.superclass.constructor.call(this);this.params=null;this.tohex=function(){var params=this.params;var a=[];a.push(new _DERObjectIdentifier(params.type));if(params.content!=undefined&&(params.content.hex!=undefined||params.content.str!=undefined)&&params.isDetached!=true){var dOctStr=new _DEROctetString(params.content);var dEContent=new _DERTaggedObject({tag:"a0",explicit:true,obj:dOctStr});a.push(dEContent)}var seq=new _DERSequence({array:a});return seq.tohex()};this.getEncodedHex=function(){return this.tohex()};this.setByParam=function(params){this.params=params};if(params!=undefined)this.setByParam(params)};extendClass(KJUR.asn1.cms.EncapsulatedContentInfo,KJUR.asn1.ASN1Object);KJUR.asn1.cms.ContentInfo=function(params){var _KJUR=KJUR,_KJUR_asn1=_KJUR.asn1,_DERTaggedObject=_KJUR_asn1.DERTaggedObject,_DERSequence=_KJUR_asn1.DERSequence,_DERObjectIdentifier=_KJUR_asn1.DERObjectIdentifier,_KJUR_asn1_x509=_KJUR_asn1.x509,_name2obj=_KJUR_asn1_x509.OID.name2obj;KJUR.asn1.cms.ContentInfo.superclass.constructor.call(this);this.params=null;this.tohex=function(){var params=this.params;var a=[];a.push(new _DERObjectIdentifier(params.type));var dContent0=new _DERTaggedObject({tag:"a0",explicit:true,obj:params.obj});a.push(dContent0);var seq=new _DERSequence({array:a});return seq.tohex()};this.getEncodedHex=function(){return this.tohex()};this.setByParam=function(params){this.params=params};if(params!=undefined)this.setByParam(params)};extendClass(KJUR.asn1.cms.ContentInfo,KJUR.asn1.ASN1Object);KJUR.asn1.cms.SignedData=function(params){var _Error=Error,_KJUR=KJUR,_KJUR_asn1=_KJUR.asn1,_ASN1Object=_KJUR_asn1.ASN1Object,_DERInteger=_KJUR_asn1.DERInteger,_DERSet=_KJUR_asn1.DERSet,_DERSequence=_KJUR_asn1.DERSequence,_DERTaggedObject=_KJUR_asn1.DERTaggedObject,_KJUR_asn1_cms=_KJUR_asn1.cms,_EncapsulatedContentInfo=_KJUR_asn1_cms.EncapsulatedContentInfo,_SignerInfo=_KJUR_asn1_cms.SignerInfo,_ContentInfo=_KJUR_asn1_cms.ContentInfo,_CertificateSet=_KJUR_asn1_cms.CertificateSet,_RevocationInfoChoices=_KJUR_asn1_cms.RevocationInfoChoices,_KJUR_asn1_x509=_KJUR_asn1.x509,_AlgorithmIdentifier=_KJUR_asn1_x509.AlgorithmIdentifier;KJUR.asn1.cms.SignedData.superclass.constructor.call(this);this.params=null;this.checkAndFixParam=function(){var sdparams=this.params;this._setDigestAlgs(sdparams);this._setContentTypeByEContent(sdparams);this._setMessageDigestByEContent(sdparams);this._setSignerInfoVersion(sdparams);this._setSignedDataVersion(sdparams)};this._setDigestAlgs=function(sdparams){var pHash={};var sinfos=sdparams.sinfos;for(var i=0;i<sinfos.length;i++){var sinfo=sinfos[i];pHash[sinfo.hashalg]=1}sdparams.hashalgs=Object.keys(pHash).sort()};this._setContentTypeByEContent=function(sdparams){var type=sdparams.econtent.type;var sinfos=sdparams.sinfos;for(var i=0;i<sinfos.length;i++){var sinfo=sinfos[i];var ctParam=this._getAttrParamByName(sinfo,"contentType");if(ctParam!==undefined)ctParam.type=type}};this._setMessageDigestByEContent=function(sdparams){var econtent=sdparams.econtent;var type=sdparams.econtent.type;var hContent=econtent.content.hex;if(hContent==undefined&&econtent.type=="data"&&econtent.content.str!=undefined){hContent=rstrtohex(econtent.content.str)}var sinfos=sdparams.sinfos;for(var i=0;i<sinfos.length;i++){var sinfo=sinfos[i];var hashalg=sinfo.hashalg;var mdParam=this._getAttrParamByName(sinfo,"messageDigest");if(mdParam!==undefined&&hContent!==undefined){var hNew=KJUR.crypto.Util.hashHex(hContent,hashalg);mdParam.hex=hNew}}};this._getAttrParamByName=function(siParam,attrName){if(siParam.sattrs===undefined)return;var aSattrs=siParam.sattrs.array;for(var i=0;i<aSattrs.length;i++){if(aSattrs[i].attr==attrName)return aSattrs[i]}};this._setSignerInfoVersion=function(sdparams){var sinfos=sdparams.sinfos;for(var i=0;i<sinfos.length;i++){var sinfo=sinfos[i];var newVersion=1;if(sinfo.id.type=="skid")newVersion=3;sinfo.version=newVersion}};this._setSignedDataVersion=function(sdparams){var newVersion=this._getSignedDataVersion(sdparams);sdparams.version=newVersion};this._getSignedDataVersion=function(sdparams){if(sdparams.revinfos!=undefined){var revinfos=sdparams.revinfos;for(var i=0;i<revinfos.length;i++){var revinfo=revinfos[i];if(revinfo.ocsp!=undefined)return 5}}var sinfos=sdparams.sinfos;for(var i=0;i<sinfos.length;i++){var sinfo=sdparams.sinfos[i];if(sinfo.version==3)return 3}if(sdparams.econtent.type!="data")return 3;return 1};this.tohex=function(){var params=this.params;if(this.getEncodedHexPrepare!=undefined){this.getEncodedHexPrepare()}if(params.fixed!=true){this.checkAndFixParam()}var a=[];a.push(new _DERInteger({int:params.version}));var aHashAlg=[];for(var i=0;i<params.hashalgs.length;i++){var name=params.hashalgs[i];aHashAlg.push(new _AlgorithmIdentifier({name:name}))}a.push(new _DERSet({array:aHashAlg}));a.push(new _EncapsulatedContentInfo(params.econtent));if(params.certs!=undefined){a.push(new _CertificateSet(params.certs))}if(params.revinfos!=undefined){a.push(new _RevocationInfoChoices(params.revinfos))}var aSignerInfo=[];for(var i=0;i<params.sinfos.length;i++){var pSI=params.sinfos[i];aSignerInfo.push(new _SignerInfo(pSI))}a.push(new _DERSet({array:aSignerInfo}));var seq=new _DERSequence({array:a});return seq.tohex()};this.getEncodedHex=function(){return this.tohex()};this.getContentInfo=function(){var dContentInfo=new _ContentInfo({type:"signed-data",obj:this});return dContentInfo};this.getContentInfoEncodedHex=function(){return this.getContentInfo().tohex()};if(params!=undefined)this.setByParam(params)};extendClass(KJUR.asn1.cms.SignedData,KJUR.asn1.ASN1Object);KJUR.asn1.cms.CertificateSet=function(params){KJUR.asn1.cms.CertificateSet.superclass.constructor.call(this);var _Error=Error,_KJUR_asn1=KJUR.asn1,_DERTaggedObject=_KJUR_asn1.DERTaggedObject,_DERSet=_KJUR_asn1.DERSet,_ASN1Object=_KJUR_asn1.ASN1Object;this.params=null;this.tohex=function(){var params=this.params;var a=[];var aParam;if(params instanceof Array){aParam=params}else if(params.array!=undefined){aParam=params.array}else{throw new _Error("cert array not specified")}for(var i=0;i<aParam.length;i++){var pem=aParam[i];var hCert;if(pem.substring(0,2)==="30")hCert=pem;else hCert=pemtohex(pem);var dCert=new _ASN1Object;dCert.hTLV=hCert;a.push(dCert)}var pSet={array:a};if(params.sortflag==false)pSet.sortflag=false;var dSet=new _DERSet(pSet);var dTagObj=new _DERTaggedObject({tag:"a0",explicit:false,obj:dSet});return dTagObj.tohex()};this.getEncodedHex=function(){return this.tohex()};if(params!=undefined)this.setByParam(params)};extendClass(KJUR.asn1.cms.CertificateSet,KJUR.asn1.ASN1Object);KJUR.asn1.cms.RevocationInfoChoices=function(params){KJUR.asn1.cms.RevocationInfoChoices.superclass.constructor.call(this);this.params=null;this.tohex=function(){var params=this.params;if(!params instanceof Array)throw new Error("params is not array");var a=[];for(var i=0;i<params.length;i++){a.push(new KJUR.asn1.cms.RevocationInfoChoice(params[i]))}var dRevInfos=KJUR.asn1.ASN1Util.newObject({tag:{tagi:"a1",obj:{set:a}}});return dRevInfos.tohex()};this.getEncodedHex=function(){return this.tohex()};if(params!=undefined)this.setByParam(params)};extendClass(KJUR.asn1.cms.RevocationInfoChoices,KJUR.asn1.ASN1Object);KJUR.asn1.cms.RevocationInfoChoice=function(params){KJUR.asn1.cms.RevocationInfoChoice.superclass.constructor.call(this);this.params=null;this.tohex=function(){var params=this.params;if(params.crl!=undefined&&typeof params.crl=="string"){var hCRL=params.crl;if(params.crl.indexOf("-----BEGIN")!=-1){hCRL=pemtohex(params.crl)}return hCRL}else if(params.ocsp!=undefined){var dTag1=KJUR.asn1.ASN1Util.newObject({tag:{tagi:"a1",obj:new KJUR.asn1.cms.OtherRevocationFormat(params)}});return dTag1.tohex()}else{throw new Error("property crl or ocsp undefined")}};this.getEncodedHex=function(){return this.tohex()};if(params!=undefined)this.setByParam(params)};extendClass(KJUR.asn1.cms.RevocationInfoChoice,KJUR.asn1.ASN1Object);KJUR.asn1.cms.OtherRevocationFormat=function(params){KJUR.asn1.cms.OtherRevocationFormat.superclass.constructor.call(this);var _Error=Error,_KJUR=KJUR,_KJUR_asn1=_KJUR.asn1,_newObject=_KJUR_asn1.ASN1Util.newObject,_isHex=_KJUR.lang.String.isHex;this.params=null;this.tohex=function(){var params=this.params;if(params.ocsp==undefined)throw new _Error("property ocsp not specified");if(!_isHex(params.ocsp)||!ASN1HEX.isASN1HEX(params.ocsp))throw new _Error("ocsp value not ASN.1 hex string");var dOtherRev=_newObject({seq:[{oid:"1.3.6.1.5.5.7.16.2"},{asn1:{tlv:params.ocsp}}]});return dOtherRev.tohex()};this.getEncodedHex=function(){return this.tohex()};if(params!=undefined)this.setByParam(params)};extendClass(KJUR.asn1.cms.OtherRevocationFormat,KJUR.asn1.ASN1Object);KJUR.asn1.cms.CMSUtil=new function(){};KJUR.asn1.cms.CMSUtil.newSignedData=function(param){return new KJUR.asn1.cms.SignedData(param)};KJUR.asn1.cms.CMSUtil.verifySignedData=function(param){var _KJUR=KJUR,_KJUR_asn1=_KJUR.asn1,_KJUR_asn1_cms=_KJUR_asn1.cms,_SignerInfo=_KJUR_asn1_cms.SignerInfo,_SignedData=_KJUR_asn1_cms.SignedData,_SigningTime=_KJUR_asn1_cms.SigningTime,_SigningCertificate=_KJUR_asn1_cms.SigningCertificate,_SigningCertificateV2=_KJUR_asn1_cms.SigningCertificateV2,_KJUR_asn1_cades=_KJUR_asn1.cades,_SignaturePolicyIdentifier=_KJUR_asn1_cades.SignaturePolicyIdentifier,_isHex=_KJUR.lang.String.isHex,_ASN1HEX=ASN1HEX,_getVbyList=_ASN1HEX.getVbyList,_getTLVbyList=_ASN1HEX.getTLVbyList,_getIdxbyList=_ASN1HEX.getIdxbyList,_getChildIdx=_ASN1HEX.getChildIdx,_getTLV=_ASN1HEX.getTLV,_oidname=_ASN1HEX.oidname,_hashHex=_KJUR.crypto.Util.hashHex;if(param.cms===undefined&&!_isHex(param.cms)){}var hCMS=param.cms;var _findSignerInfos=function(hCMS,result){var idx;for(var i=3;i<6;i++){idx=_getIdxbyList(hCMS,0,[1,0,i]);if(idx!==undefined){var tag=hCMS.substr(idx,2);if(tag==="a0")result.certsIdx=idx;if(tag==="a1")result.revinfosIdx=idx;if(tag==="31")result.signerinfosIdx=idx}}};var _parseSignerInfos=function(hCMS,result){var idxSignerInfos=result.signerinfosIdx;if(idxSignerInfos===undefined)return;var idxList=_getChildIdx(hCMS,idxSignerInfos);result.signerInfoIdxList=idxList;for(var i=0;i<idxList.length;i++){var idxSI=idxList[i];var info={idx:idxSI};_parseSignerInfo(hCMS,info);result.signerInfos.push(info)}};var _parseSignerInfo=function(hCMS,info){var idx=info.idx;info.signerid_issuer1=_getTLVbyList(hCMS,idx,[1,0],"30");info.signerid_serial1=_getVbyList(hCMS,idx,[1,1],"02");info.hashalg=_oidname(_getVbyList(hCMS,idx,[2,0],"06"));var idxSignedAttrs=_getIdxbyList(hCMS,idx,[3],"a0");info.idxSignedAttrs=idxSignedAttrs;_parseSignedAttrs(hCMS,info,idxSignedAttrs);var aIdx=_getChildIdx(hCMS,idx);var n=aIdx.length;if(n<6)throw"malformed SignerInfo";info.sigalg=_oidname(_getVbyList(hCMS,idx,[n-2,0],"06"));info.sigval=_getVbyList(hCMS,idx,[n-1],"04")};var _parseSignedAttrs=function(hCMS,info,idx){var aIdx=_getChildIdx(hCMS,idx);info.signedAttrIdxList=aIdx;for(var i=0;i<aIdx.length;i++){var idxAttr=aIdx[i];var hAttrType=_getVbyList(hCMS,idxAttr,[0],"06");var v;if(hAttrType==="2a864886f70d010905"){v=hextoutf8(_getVbyList(hCMS,idxAttr,[1,0]));info.saSigningTime=v}else if(hAttrType==="2a864886f70d010904"){v=_getVbyList(hCMS,idxAttr,[1,0],"04");info.saMessageDigest=v}}};var _parseSignedData=function(hCMS,result){if(_getVbyList(hCMS,0,[0],"06")!=="2a864886f70d010702"){return result}result.cmsType="signedData";result.econtent=_getVbyList(hCMS,0,[1,0,2,1,0]);_findSignerInfos(hCMS,result);result.signerInfos=[];_parseSignerInfos(hCMS,result)};var _verify=function(hCMS,result){var aSI=result.parse.signerInfos;var n=aSI.length;var isValid=true;for(var i=0;i<n;i++){var si=aSI[i];_verifySignerInfo(hCMS,result,si,i);if(!si.isValid)isValid=false}result.isValid=isValid};var _findCert=function(hCMS,result,si,idx){var certsIdx=result.parse.certsIdx;var aCert;if(result.certs===undefined){aCert=[];result.certkeys=[];var aIdx=_getChildIdx(hCMS,certsIdx);for(var i=0;i<aIdx.length;i++){var hCert=_getTLV(hCMS,aIdx[i]);var x=new X509;x.readCertHex(hCert);aCert[i]=x;result.certkeys[i]=x.getPublicKey()}result.certs=aCert}else{aCert=result.certs}result.cccc=aCert.length;result.cccci=aIdx.length;for(var i=0;i<aCert.length;i++){var issuer2=x.getIssuerHex();var serial2=x.getSerialNumberHex();if(si.signerid_issuer1===issuer2&&si.signerid_serial1===serial2){si.certkey_idx=i}}};var _verifySignerInfo=function(hCMS,result,si,idx){si.verifyDetail={};var _detail=si.verifyDetail;var econtent=result.parse.econtent;var hashalg=si.hashalg;var saMessageDigest=si.saMessageDigest;_detail.validMessageDigest=false;if(_hashHex(econtent,hashalg)===saMessageDigest)_detail.validMessageDigest=true;_findCert(hCMS,result,si,idx);_detail.validSignatureValue=false;var sigalg=si.sigalg;var hSignedAttr="31"+_getTLV(hCMS,si.idxSignedAttrs).substr(2);si.signedattrshex=hSignedAttr;var pubkey=result.certs[si.certkey_idx].getPublicKey();var sig=new KJUR.crypto.Signature({alg:sigalg});sig.init(pubkey);sig.updateHex(hSignedAttr);var isValid=sig.verify(si.sigval);_detail.validSignatureValue_isValid=isValid;if(isValid===true)_detail.validSignatureValue=true;si.isValid=false;if(_detail.validMessageDigest&&_detail.validSignatureValue){si.isValid=true}};var _findSignerCert=function(){};var result={isValid:false,parse:{}};_parseSignedData(hCMS,result.parse);_verify(hCMS,result);return result};KJUR.asn1.cms.CMSParser=function(){var _Error=Error,_X509=X509,_x509obj=new _X509,_ASN1HEX=ASN1HEX,_getV=_ASN1HEX.getV,_getTLV=_ASN1HEX.getTLV,_getIdxbyList=_ASN1HEX.getIdxbyList,_getTLVbyList=_ASN1HEX.getTLVbyList,_getTLVbyListEx=_ASN1HEX.getTLVbyListEx,_getVbyList=_ASN1HEX.getVbyList,_getVbyListEx=_ASN1HEX.getVbyListEx,_getChildIdx=_ASN1HEX.getChildIdx;this.getCMSSignedData=function(h){var hSignedData=_getTLVbyList(h,0,[1,0]);var pResult=this.getSignedData(hSignedData);return pResult};this.getSignedData=function(h){var aIdx=_getChildIdx(h,0);var pResult={};var hVersion=_getV(h,aIdx[0]);var iVersion=parseInt(hVersion,16);pResult.version=iVersion;var hHashAlgs=_getTLV(h,aIdx[1]);pResult.hashalgs=this.getHashAlgArray(hHashAlgs);var hEContent=_getTLV(h,aIdx[2]);pResult.econtent=this.getEContent(hEContent);var hCerts=_getTLVbyListEx(h,0,["[0]"]);if(hCerts!=null){pResult.certs=this.getCertificateSet(hCerts)}var hRevInfos=_getTLVbyListEx(h,0,["[1]"]);if(hRevInfos!=null){}var hSignerInfos=_getTLVbyListEx(h,0,[3]);pResult.sinfos=this.getSignerInfos(hSignerInfos);return pResult};this.getHashAlgArray=function(h){var aIdx=_getChildIdx(h,0);var x=new _X509;var a=[];for(var i=0;i<aIdx.length;i++){var hAlg=_getTLV(h,aIdx[i]);var sAlg=x.getAlgorithmIdentifierName(hAlg);a.push(sAlg)}return a};this.getEContent=function(h){var pResult={};var hType=_getVbyList(h,0,[0]);var hContent=_getVbyList(h,0,[1,0]);pResult.type=KJUR.asn1.x509.OID.oid2name(ASN1HEX.hextooidstr(hType));pResult.content={hex:hContent};return pResult};this.getSignerInfos=function(h){var aResult=[];var aIdx=_getChildIdx(h,0);for(var i=0;i<aIdx.length;i++){var hSignerInfo=_getTLV(h,aIdx[i]);var pSignerInfo=this.getSignerInfo(hSignerInfo);aResult.push(pSignerInfo)}return aResult};this.getSignerInfo=function(h){var pResult={};var aIdx=_getChildIdx(h,0);var iVersion=_ASN1HEX.getInt(h,aIdx[0],-1);if(iVersion!=-1)pResult.version=iVersion;var hSI=_getTLV(h,aIdx[1]);var pSI=this.getIssuerAndSerialNumber(hSI);pResult.id=pSI;var hAlg=_getTLV(h,aIdx[2]);var sAlg=_x509obj.getAlgorithmIdentifierName(hAlg);pResult.hashalg=sAlg;var hSattrs=_getTLVbyListEx(h,0,["[0]"]);if(hSattrs!=null){var aSattrs=this.getAttributeList(hSattrs);pResult.sattrs=aSattrs}var hSigAlg=_getTLVbyListEx(h,0,[3]);var sSigAlg=_x509obj.getAlgorithmIdentifierName(hSigAlg);pResult.sigalg=sSigAlg;var hSigHex=_getVbyListEx(h,0,[4]);pResult.sighex=hSigHex;var hUattrs=_getTLVbyListEx(h,0,["[1]"]);if(hUattrs!=null){var aUattrs=this.getAttributeList(hUattrs);pResult.uattrs=aUattrs}return pResult};this.getSignerIdentifier=function(h){if(h.substr(0,2)=="30"){return this.getIssuerAndSerialNumber(h)}else{throw new Error("SKID of signerIdentifier not supported")}};this.getIssuerAndSerialNumber=function(h){var pResult={type:"isssn"};var aIdx=_getChildIdx(h,0);var hName=_getTLV(h,aIdx[0]);pResult.issuer=_x509obj.getX500Name(hName);var hSerial=_getV(h,aIdx[1]);pResult.serial={hex:hSerial};return pResult};this.getAttributeList=function(h){var a=[];var aIdx=_getChildIdx(h,0);for(var i=0;i<aIdx.length;i++){var hAttr=_getTLV(h,aIdx[i]);var pAttr=this.getAttribute(hAttr);a.push(pAttr)}return{array:a}};this.getAttribute=function(h){var pResult={};var aIdx=_getChildIdx(h,0);var attrTypeOID=_ASN1HEX.getOID(h,aIdx[0]);var attrType=KJUR.asn1.x509.OID.oid2name(attrTypeOID);pResult.attr=attrType;var hSet=_getTLV(h,aIdx[1]);var aSetIdx=_getChildIdx(hSet,0);if(aSetIdx.length==1){pResult.valhex=_getTLV(hSet,aSetIdx[0])}else{var a=[];for(var i=0;i<aSetIdx.length;i++){a.push(_getTLV(hSet,aSetIdx[i]))}pResult.valhex=a}if(attrType=="contentType"){this.setContentType(pResult)}else if(attrType=="messageDigest"){this.setMessageDigest(pResult)}else if(attrType=="signingTime"){this.setSigningTime(pResult)}else if(attrType=="signingCertificate"){this.setSigningCertificate(pResult)}else if(attrType=="signingCertificateV2"){this.setSigningCertificateV2(pResult)}else if(attrType=="signaturePolicyIdentifier"){this.setSignaturePolicyIdentifier(pResult)}return pResult};this.setContentType=function(pAttr){var contentType=_ASN1HEX.getOIDName(pAttr.valhex,0,null);if(contentType!=null){pAttr.type=contentType;delete pAttr.valhex}};this.setSigningTime=function(pAttr){var hSigningTime=_getV(pAttr.valhex,0);var signingTime=hextoutf8(hSigningTime);pAttr.str=signingTime;delete pAttr.valhex};this.setMessageDigest=function(pAttr){var hMD=_getV(pAttr.valhex,0);pAttr.hex=hMD;delete pAttr.valhex};this.setSigningCertificate=function(pAttr){var aIdx=_getChildIdx(pAttr.valhex,0);if(aIdx.length>0){var hCerts=_getTLV(pAttr.valhex,aIdx[0]);var aCertIdx=_getChildIdx(hCerts,0);var a=[];for(var i=0;i<aCertIdx.length;i++){var hESSCertID=_getTLV(hCerts,aCertIdx[i]);var pESSCertID=this.getESSCertID(hESSCertID);a.push(pESSCertID)}pAttr.array=a}if(aIdx.length>1){var hPolicies=_getTLV(pAttr.valhex,aIdx[1]);pAttr.polhex=hPolicies}delete pAttr.valhex};this.setSignaturePolicyIdentifier=function(pAttr){var aIdx=_getChildIdx(pAttr.valhex,0);if(aIdx.length>0){var oid=_ASN1HEX.getOID(pAttr.valhex,aIdx[0]);pAttr.oid=oid}if(aIdx.length>1){var x=new _X509;var a2Idx=_getChildIdx(pAttr.valhex,aIdx[1]);var hAlg=_getTLV(pAttr.valhex,a2Idx[0]);var sAlg=x.getAlgorithmIdentifierName(hAlg);pAttr.alg=sAlg;var hHash=_getV(pAttr.valhex,a2Idx[1]);pAttr.hash=hHash}delete pAttr.valhex};this.setSigningCertificateV2=function(pAttr){var aIdx=_getChildIdx(pAttr.valhex,0);if(aIdx.length>0){var hCerts=_getTLV(pAttr.valhex,aIdx[0]);var aCertIdx=_getChildIdx(hCerts,0);var a=[];for(var i=0;i<aCertIdx.length;i++){var hESSCertIDv2=_getTLV(hCerts,aCertIdx[i]);var pESSCertIDv2=this.getESSCertIDv2(hESSCertIDv2);a.push(pESSCertIDv2)}pAttr.array=a}if(aIdx.length>1){var hPolicies=_getTLV(pAttr.valhex,aIdx[1]);pAttr.polhex=hPolicies}delete pAttr.valhex};this.getESSCertID=function(h){var pResult={};var aIdx=_getChildIdx(h,0);if(aIdx.length>0){var hCertHash=_getV(h,aIdx[0]);pResult.hash=hCertHash}if(aIdx.length>1){var hIssuerSerial=_getTLV(h,aIdx[1]);var pIssuerSerial=this.getIssuerSerial(hIssuerSerial);if(pIssuerSerial.serial!=undefined)pResult.serial=pIssuerSerial.serial;if(pIssuerSerial.issuer!=undefined)pResult.issuer=pIssuerSerial.issuer}return pResult};this.getESSCertIDv2=function(h){var aResult={};var aIdx=_getChildIdx(h,0);if(aIdx.length<1||3<aIdx.length)throw new _Error("wrong number of elements");var offset=0;if(h.substr(aIdx[0],2)=="30"){var hHashAlg=_getTLV(h,aIdx[0]);aResult.alg=_x509obj.getAlgorithmIdentifierName(hHashAlg);offset++}else{aResult.alg="sha256"}var hHash=_getV(h,aIdx[offset]);aResult.hash=hHash;if(aIdx.length>offset+1){var hIssuerSerial=_getTLV(h,aIdx[offset+1]);var pIssuerSerial=this.getIssuerSerial(hIssuerSerial);aResult.issuer=pIssuerSerial.issuer;aResult.serial=pIssuerSerial.serial}return aResult};this.getIssuerSerial=function(h){var pResult={};var aIdx=_getChildIdx(h,0);var hIssuer=_getTLV(h,aIdx[0]);var pIssuerGN=_x509obj.getGeneralNames(hIssuer);var pIssuerName=pIssuerGN[0].dn;pResult.issuer=pIssuerName;var hSerial=_getV(h,aIdx[1]);pResult.serial={hex:hSerial};return pResult};this.getCertificateSet=function(h){var aIdx=_getChildIdx(h,0);var a=[];for(var i=0;i<aIdx.length;i++){var hCert=_getTLV(h,aIdx[i]);if(hCert.substr(0,2)=="30"){var pem=hextopem(hCert,"CERTIFICATE");a.push(pem)}}return{array:a,sortflag:false}}};
